<!--

EdgeMAX Wizard "0xFF-BMK-Webstatus-LetsEncrypt" created 02/2017 by CPO/BMK for FunkFeuer.at
Works on EdgeRouter and EdgeRouter X / X-SFP (system version 1.7.0+)

-->
<div class="instructions">
    <h3>0xFF-BMK-Webstatus with Let's Encrypt setup</h3>
</div>
<legend style="position:absolute;right:0px;padding:5px;">
    <center>EdgeMAX Wizard "0xFF-BMK-Webstatus-LetsEncrypt"<br>created 02/2017 by CPO/BMK for FunkFeuer.at<br>
    Version 20170221a/bmk4.2</center>
</legend>
<div style="padding:15px;border: 1px solid lightgray;width:648px">
  <table border="0">
    <tr><td style="vertical-align:middle">Package Status:</td><td><input style="right:10px" id="pkgstatus" name="pkgstatus" type="text" size="60" disabled /></td></tr>
    <tr><td style="vertical-align:middle">BMK-webstatus:</td> <td><input style="right:10px" id="wsstatus" name="wsstatus" type="text" size="60" disabled /></td></tr>
    <tr><td style="vertical-align:middle">Let's Encrypt:</td> <td><input style="right:10px" id="lestatus" name="lestatus" type="text" size="60" disabled /></td></tr>
    <tr><td style="vertical-align:middle">Certificates:</td>  <td><input style="right:10px" id="cestatus" name="cestatus" type="text" size="60" disabled /></td></tr>
    <tr><td style="vertical-align:middle">Orig-Server-Ports:</td><td>
       <input style="right:10px" id="orighttpport"  name="orighttpport"  type="number" size="6" />
       <input style="right:10px" id="orighttpsport" name="orighttpsport" type="number" size="6" /> (WebGUI!!)
    </td></tr>
    <tr><td style="vertical-align:middle">Custom-Server-Ports:</td><td>
       <input style="right:10px" id="customhttpport"  name="customhttpport"  type="number" size="6" /> 
       <input style="right:10px" id="customhttpsport" name="customhttpsport" type="number" size="6" /> (Cert-Check!!)
    </td></tr>
    <tr><td style="vertical-align:middle" colspan=2>
       Change ports with care!<br>
       Lets-Encrypt registration and renewal needs custom-server http-port to be 80.<br>
       WebGui breaks on changing orig-server https-port** OR on restarting orig-server**<br>
       Installing BMK-Webpackage will migrate original webserver to ports 81/8443 to install custom webserver on ports 80/443.**<br>
       <br>
       ** this will result in the error message "apply failed"<br>
    </td></tr>
    <tr><td style="vertical-align:middle">Current DNS</td><td><input style="right:10px" id="currentfqdn" name="currentfqdn" type="text" size="40" disabled /><input style="right:10px" id="currentdet" name="currentdet" type="text" size="15" disabled /></td></tr>
    <tr><td style="vertical-align:middle">Domain-Key FQDN</td><td><input style="right:10px" id="domainfqdn" name="domainfqdn" type="text" size="40" disabled /></td></tr>
    <tr><td style="vertical-align:middle">Certificate FQDN</td><td><input style="right:10px" id="certfqdn" name="certfqdn" type="text" size="40" disabled /> </td></tr>
    <tr><td style="vertical-align:middle">Certificate Validity</td><td>
                                          <input style="right:10px" id="certfrom" name="certfrom" type="text" size="20" disabled /> 
                                       to <input style="right:10px" id="certuntil" name="certuntil" type="text" size="20" disabled /> 
                                          <input style="right:10px" id="certexpire" name="certexpire" type="text" size="15" disabled /> </td></tr>
  </table>
</div>

<fieldset id="cefiles" name="cefiles" class="primary expanded">
    <legend>Let's Encrypt files</legend>
    <div class="addable" data-min="0" data-max="10" data-object="cefiles" data-objectify="1">
        <div class="addable-template" style="padding-top:0px;">
            <div class="multi">
                <div>File      <input id="name" name="name" size="50" disabled /></div>
                <div>Status    <input name="status" size="10" disabled /></div>
            </div>
        </div>
        <div class="addable-container"></div>
        <!-- although hidden, this add-button needs to exist! //-->
        <button type="button" class="addable-add" style="position:absolute;right:0px;opacity:0.0;filter:alpha(opacity=0);" disabled></button>
    </div>
</fieldset>

<fieldset id="wsfiles" name="wsfiles" class="primary closed">
    <legend>BMK-WebStatus php files</legend>
    <div class="addable" data-min="0" data-max="99" data-object="wsfiles" data-objectify="1">
        <span><b><u>Files checked</u></b></span>
        <div class="addable-template" style="padding-top:0px;">
            <div class="multi">
                <div>File-Name <input id="name" name="name" size="50" disabled /></div>
                <div>Status    <input name="status" size="10" disabled /></div>
            </div>
        </div>
        <div class="addable-container"></div>
        <!-- although hidden, this add-button needs to exist! //-->
        <button type="button" class="addable-add" style="position:absolute;right:0px;opacity:0.0;filter:alpha(opacity=0);" disabled></button>
    </div>
</fieldset>

<fieldset id="lefiles" name="lefiles" class="primary closed">
    <legend>Let's Encrypt files</legend>
    <div class="addable" data-min="0" data-max="99" data-object="lefiles" data-objectify="1">
        <span><b><u>Files checked</u></b></span>
        <div class="addable-template" style="padding-top:0px;">
            <div class="multi">
                <div>File-Name <input id="name" name="name" size="50" disabled /></div>
                <div>Status    <input name="status" size="10" disabled /></div>
            </div>
        </div>
        <div class="addable-container"></div>
        <!-- although hidden, this add-button needs to exist! //-->
        <button type="button" class="addable-add" style="position:absolute;right:0px;opacity:0.0;filter:alpha(opacity=0);" disabled></button>
    </div>
</fieldset>

<fieldset id="allfiles" name="allfiles" class="primary closed">
    <legend>File-Liste overall</legend>
    <div class="addable" data-min="0" data-max="99" data-object="allfiles" data-objectify="1">
        <span><b><u>Files found</u></b></span>
        <div class="addable-template" style="padding-top:0px;">
            <div class="multi">
                <div>File-Name <input id="name" name="name" size="50" disabled /></div>
                <div>Status    <input name="status" size="10" disabled /></div>
            </div>
        </div>
        <div class="addable-container"></div>
        <!-- although hidden, this add-button needs to exist! //-->
        <button type="button" class="addable-add" style="position:absolute;right:0px;opacity:0.0;filter:alpha(opacity=0);" disabled></button>
    </div>
</fieldset>

<fieldset id="bmkconfig" name="bmkconfig" class="primary expanded">
    <legend>Configuratoin BMK-Webstatus-Page</legend>
    <span>Interface-List:</span>         <input id="bmkinferfacelist"    name="bmkinferfacelist"    type="text" size="70" /><br>
    <span>Traceroute-Destination:</span> <input id="bmktracerouteip"     name="bmktracerouteip"     type="text" size="30" /><br>
    <input id="bmkadminlink"         name="bmkadminlink"         type="checkbox" /> <span>Show link to admin login page</span><br>
    <input id="bmknodedblookup"      name="bmknodedblookup"      type="checkbox" /> <span>Load node data for name lookup and route/node count</span><br>
</fieldset>

<div style="padding:15px;border: 1px solid lightgray;width:648px">
    <input id="installbmkpackage"    name="installbmkpackage"    type="checkbox" /><span> Install 0xFF-BMK-Webstatus-LetsEcrypt Package v4.2 on 'Apply'</span><br>
    <input id="registercert"         name="registercert"         type="checkbox" /><span> Register FQDN and renew/install Certificate on 'Apply'</span><br>
    <input id="restartorigenabled"   name="restartorigenabled"   type="checkbox" /><span> Restart original lighttpd on 'Apply'</span><br>
    <input id="restartcustomenabled" name="restartcustomenabled" type="checkbox" /><span> Restart custom lighttpd on 'Apply'.</span><br>
    <br>
    Wizard will raise the error "save failed" as webservices will restart and break the response session.
</div>
<br><br>
<script>
function disable_group(group) {
    var nodes = document.getElementById(group).getElementsByTagName('*');
    for(var i=0; i<nodes.length; i++) { 
        if (nodes[i].name == null) {
        } else if (nodes[i].name.match(/status/)) {
            if (nodes[i].value.match(/err/)) {
                nodes[i].style.color = "red";
            } else if (nodes[i].value.match(/old|link|missing/)) {
                nodes[i].style.color = "orange";
            } else if (nodes[i].value.match(/ok/)) {
                nodes[i].style.color = "green";
            }
        }
        nodes[i].disabled = true; 
    }
}
function colors() {
    var input = document.getElementById('pkgstatus');
    input.style.color = "black";
    if (input.value.match(/error/)) {
        input.style.color = "red";
        //disable();
    } else if (input.value.match(/success/)) {
        input.style.color = "green";
        //enable();
    }
    // cert expiary colors
    var certexpire = document.getElementById('certexpire');
    var certfrom = document.getElementById('certfrom');
    var certuntil = document.getElementById('certuntil');
    certexpire.style.color = "black";
    certfrom.style.color   = "black";
    certuntil.style.color  = "black";
    if(certexpire.value.match(/expired/)) {
        certexpire.style.color = "red";
        certfrom.style.color   = "red";
        certuntil.style.color  = "red";
    } else if (certexpire.value.match(/left/)) {
        certexpire.style.color = "green";
        certfrom.style.color   = "green";
        certuntil.style.color  = "green";
    }
    // FQDN values
    var currentfqdn = document.getElementById('currentfqdn');
    var certfqdn = document.getElementById('certfqdn');
    var domainfqdn = document.getElementById('domainfqdn');
    certfqdn.style.color   = "black";
    domainfqdn.style.color = "black";
    currentfqdn.style.color = "black";
    if ((certfqdn.value==domainfqdn.value) && (certfqdn.value==currentfqdn.value) && (!(currentfqdn.value.match(/not available/)))) {
        currentfqdn.style.color = "green";
        certfqdn.style.color   = "green";
        domainfqdn.style.color  = "green";
    } else if (certfqdn.value==domainfqdn.value) {
        if (certfqdn.value=='not available') {
            if (currentfqdn.value.match(/not available/)) {
                currentfqdn.style.color = "orange";
            }
        } else {
            certfqdn.style.color   = "green";
            domainfqdn.style.color = "green";
            if (currentfqdn.value.match(/not available/)) {
                currentfqdn.style.color = "orange";
            } else {
                currentfqdn.style.color = "red";
            }
        }
    }
    certexpire.disabled = true;
    certfrom.disabled = true;
    certuntil.disabled = true;
    currentfqdn.disabled = true;
    certfqdn.disabled = true;
    domainfqdn.disabled = true;
    
    document.getElementById('pkgstatus').disabled = true;
    document.getElementById('wsstatus').disabled = true;
    document.getElementById('lestatus').disabled = true;
    document.getElementById('cestatus').disabled = true;
    //document.getElementById('restartorigenabled').disabled = true;
    //document.getElementById('orighttpport').disabled = true;
    //document.getElementById('orighttpsport').disabled = true;
    //document.getElementById('customhttpport').disabled = true;
    //document.getElementById('customhttpsport').disabled = true;
    document.getElementById('currentdet').disabled = true;
    
    disable_group('cefiles');
    disable_group('lefiles');
    disable_group('wsfiles');
    disable_group('allfiles');
}
function validate() {
}
document.onchange=function(){
    colors();
    var customhttpport = document.getElementById('customhttpport');
    var customhttpsport = document.getElementById('customhttpsport');
    if ((customhttpport.value=='0') ||(customhttpport.value==null))  { customhttpport.disabled=true;}
    if ((customhttpsport.value=='0')||(customhttpsport.value==null)) { customhttpsport.disabled=true;}
}
document.onsubmit=function(){
    colors();
}
</script>
